<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE beans PUBLIC '-//SPRING//DTD BEAN//EN' 'http://www.springframework.org/dtd/spring-beans.dtd'>

<beans>
    <bean id="ClusterService" class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="proxyInterfaces">
            <list>
                <value>org.alfresco.enterprise.repo.cluster.core.ClusterService</value>
            </list>
        </property>
        <property name="target">
            <ref bean="clusterService"/>
        </property>
        <property name="interceptorNames">
            <list>
                <idref local="clusterServiceTxInterceptor"/>
            </list>
        </property>
    </bean>
    
    <bean id="clusterService" class="org.alfresco.enterprise.repo.cluster.core.ClusterServiceImpl">
        <property name="attributeService" ref="attributeService"/>
        <property name="descriptorService" ref="DescriptorService"/>
        <property name="hazelcastInstanceFactory" ref="hazelcastInstanceFactory"/>
        <property name="serverType" value="${alfresco.cluster.nodetype}"/>
        <property name="sysAdminParams" ref="sysAdminParams"/>
        <property name="memberHostName" value="${alfresco.cluster.hostname}"/>
        <property name="jobLockService" ref="jobLockService"/>
        <property name="interfaceSpec" value="${alfresco.cluster.interface}"/>
        <property name="maxInitRetries" value="${alfresco.cluster.max.init.retries}"/>
        <property name="nonMemberAddrPicker">
            <bean class="org.alfresco.enterprise.repo.cluster.core.NonMemberIPAddressPickerImpl"/>
        </property>
    </bean>
    
    <bean id="clusterServiceTxInterceptor" class="org.alfresco.repo.transaction.RetryingTransactionInterceptor">
        <property name="transactionService">
            <ref bean="TransactionService"/>
        </property>
        <property name="transactionManager">
            <ref bean="transactionManager"/>
        </property>
        <property name="transactionAttributes">
            <props>
                <prop key="get*">${server.transaction.mode.readOnly}</prop>
                <prop key="is*">${server.transaction.mode.readOnly}</prop>
                <prop key="*">${server.transaction.mode.default}</prop>
            </props>
        </property>
    </bean>
    
    <bean id="hazelcastConfig" class="org.alfresco.enterprise.repo.cluster.core.HazelcastConfigFactoryBean">
        <property name="configFile" value="${alfresco.hazelcast.configLocation}"/>
        <property name="properties" ref="global-properties"/>
    </bean>
    
    <bean id="tcpIpConfig" class="org.alfresco.enterprise.repo.cluster.core.AlfrescoTcpIpConfig"/>
    
    <bean id="membershipChangeLogger" class="org.alfresco.enterprise.repo.cluster.core.MembershipChangeLogger"/>

    <bean id="cacheDropper" class="org.alfresco.enterprise.repo.cluster.core.MembershipChangeCacheDropper">
        <property name="enabled" value="${alfresco.cluster.memberchange.dropInvalidatingCaches}"/>
    </bean>
    
    <bean id="hazelcastInstanceFactory" class="org.alfresco.enterprise.repo.cluster.core.HazelcastInstanceFactory">
        <property name="configFactory" ref="hazelcastConfig"/>
        <property name="clusteringEnabled" value="${alfresco.cluster.enabled}"/>
        <property name="membershipListeners">
            <list>
                <ref bean="membershipChangeLogger"/>
                <ref bean="cacheDropper"/>
            </list>
        </property>
    </bean>
    
    <bean id="messengerFactory" class="org.alfresco.enterprise.repo.cluster.messenger.HazelcastMessengerFactory">
        <property name="hazelcastInstanceFactory" ref="hazelcastInstanceFactory"/>
    </bean>
    
    <!-- Set up this class for static access, don't use this for DI - use messengerFactory instead -->
    <bean id="staticMessengerFactoryProvider" class="org.alfresco.enterprise.repo.cluster.messenger.MessengerFactoryProvider">    
        <property name="instance" ref="messengerFactory"/>
    </bean>
        
    <bean id="clusterChecker" class="org.alfresco.enterprise.repo.cluster.checker.ClusterChecker" init-method="init" destroy-method="shutdown">
       <property name="authenticationService" ref="authenticationService"/>
       <property name="jobLockService" ref="jobLockService"/>
       <property name="transactionService" ref="transactionService"/>
       <property name="messengerFactory" ref="messengerFactory"/>
       <property name="timeout" value="${alfresco.clusterCheck.timeout}"/>
       <property name="clusterService" ref="ClusterService"/>
    </bean>
    
    <bean id="fileServerConfigurationFactory" class="org.alfresco.enterprise.filesys.FileServerConfigurationFactory">
       <property name="hazelcastInstanceFactory" ref="hazelcastInstanceFactory"/>
       <!-- map name as configured in hazelcast-tcp.xml -->
       <property name="mapName" value="AlfrescoFilesysCache"/>
    </bean>
         
   <bean id="lockStoreFactory" class="org.alfresco.enterprise.repo.cluster.lock.ClusterAwareLockStoreFactory">
        <property name="hazelcastInstanceFactory" ref="hazelcastInstanceFactory"/>
   </bean>
   
   <!-- Import enterprise clustered caches -->
   <import resource="classpath:alfresco/enterprise/cache/cache-context.xml"/>
</beans>