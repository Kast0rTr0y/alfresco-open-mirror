<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">
   
   
   <!--  Monitor -->
   <bean id="cloudSyncMonitor" class="org.alfresco.enterprise.repo.web.scripts.sync.transport.CloudSyncMonitorImpl"/>
   
   <bean id="cloudSyncMonitorJMX" class="org.alfresco.enterprise.repo.web.scripts.sync.transport.CloudSyncMonitorJMXBean" >
       <property name="cloudSyncMonitor" ref="cloudSyncMonitor"/>
   </bean>
   
   <bean id="CloudSyncResource" parent="managedResource">
      <property name="resource" ref="cloudSyncMonitorJMX"/>
   </bean>
   
   
   <!--                              -->
   <!--  Web Scripts for Cloud Sync  -->
   <!--                              -->

   <!-- Abstract Cloud Sync declarative web scripts -->
   <bean id="abstractCloudSyncWebScript"
          class="org.alfresco.enterprise.repo.web.scripts.sync.AbstractCloudSyncDeclarativeWebScript"
          parent="webscript" abstract="true">
        <property name="nodeService" ref="nodeService"/>
        <property name="syncAdminService" ref="SyncAdminService"/>
        <property name="cloudConnectorService" ref="CloudConnectorService"/>
   </bean>
   
   <!-- Abstract Cloud Sync abstract web scripts (only a few of these) -->
   <bean id="abstractCloudSyncAbstractWebScript"
          class="org.alfresco.enterprise.repo.web.scripts.sync.AbstractCloudSyncAbstractWebScript"
          parent="webscript" abstract="true">
        <property name="nodeService" ref="nodeService"/>
        <property name="syncService" ref="SyncService"/>
        <property name="syncAdminService" ref="SyncAdminService"/>
   </bean>
   
   <!-- Sync Set Definition management -->
   <bean id="webscript.org.alfresco.enterprise.repository.sync.syncsetdefinition.get"
         class="org.alfresco.enterprise.repo.web.scripts.sync.SyncSetDefinitionGet"
         parent="abstractCloudSyncWebScript">
   </bean>
   
   <bean id="webscript.org.alfresco.enterprise.repository.sync.syncsetdefinition.post"
         class="org.alfresco.enterprise.repo.web.scripts.sync.SyncSetDefinitionPost"
         parent="abstractCloudSyncWebScript">
   </bean>
   
   <!-- Sync Set Membership management -->
   <bean id="webscript.org.alfresco.enterprise.repository.sync.syncsetmembership.delete"
         class="org.alfresco.enterprise.repo.web.scripts.sync.SyncSetMembershipDelete"
         parent="abstractCloudSyncWebScript">
   </bean>
   
   <!-- Request Sync -->
   <bean id="webscript.org.alfresco.enterprise.repository.sync.syncrequest.post"
         class="org.alfresco.enterprise.repo.web.scripts.sync.SyncRequestPost"
         parent="abstractCloudSyncWebScript">
       <property name="syncService" ref="SyncService"/>
   </bean>
   
   <!-- GET SyncSet Manifest (sync change log - list of ssdIds for a given srcRepoId) -->
   <bean id="webscript.org.alfresco.enterprise.repository.sync.audit.syncsetmanifest.get"
         class="org.alfresco.enterprise.repo.web.scripts.sync.audit.SyncSetManifestGet"
         parent="abstractCloudSyncWebScript">
       <property name="syncAuditService" ref="SyncAuditService"/>
   </bean>
   
   <!-- GET SyncSet Changes (sync change log - list of target NodeRefs for a given ssdId) -->
   <bean id="webscript.org.alfresco.enterprise.repository.sync.audit.syncsetchanges.get"
         class="org.alfresco.enterprise.repo.web.scripts.sync.audit.SyncSetChangesGet"
         parent="abstractCloudSyncWebScript">
       <property name="syncAuditService" ref="SyncAuditService"/>
   </bean>
   
   
   <!-- Remote Synced Node -->
   <bean id="webscript.org.alfresco.enterprise.repository.sync.remotesyncednode.get"
         class="org.alfresco.enterprise.repo.web.scripts.sync.RemoteSyncedNodeGet"
         parent="webscript">
        <property name="nodeService" ref="NodeService"/>
        <property name="personService" ref="PersonService"/>
        <property name="syncAdminService" ref="SyncAdminService"/>
        <property name="checkOutCheckInService" ref="CheckOutCheckInService"/>
   </bean>
   
   <!-- Get Config -->
   <bean id="webscript.org.alfresco.enterprise.repository.sync.config.get"
         class="org.alfresco.enterprise.repo.web.scripts.sync.SyncConfigGet"
         parent="webscript">
        <property name="syncAdminService" ref="SyncAdminService"/>
   </bean>
   
   
   <!--                                        -->
   <!-- Web Scripts for Cloud Authentication   -->
   <!--                                        -->

   <!-- Fetches details of a user's cloud credentials -->
   <bean id="webscript.org.alfresco.cloud.person.credentials.get"
         class="org.alfresco.enterprise.repo.web.scripts.sync.connector.CloudCredentialsGet"
         parent="abstractCloudSyncWebScript">
   </bean>

   <!-- Validates and sets a user's cloud credentials -->
   <bean id="webscript.org.alfresco.cloud.person.credentials.post"
         class="org.alfresco.enterprise.repo.web.scripts.sync.connector.CloudCredentialsPost"
         parent="abstractCloudSyncWebScript">
   </bean>

   <!-- Removes a user's cloud credentials -->
   <bean id="webscript.org.alfresco.cloud.person.credentials.delete"
         class="org.alfresco.enterprise.repo.web.scripts.sync.connector.CloudCredentialsDelete"
         parent="abstractCloudSyncWebScript">
   </bean>


   <!--                                        -->
   <!-- Web Scripts for the sync push/pull     -->
   <!--                                        -->

   <!-- Pushes the details of a sync to a node through -->
   <bean id="webscript.org.alfresco.cloud.sync.cloud-sync-push.post"
         class="org.alfresco.enterprise.repo.web.scripts.sync.transport.CloudSyncPushPost"
         parent="abstractCloudSyncWebScript">
        <property name="cloudSyncMonitor" ref="cloudSyncMonitor"/>
        <property name="cloudSyncOnCloudService" ref="CloudSyncOnCloudService"/>
        <property name="cloudSyncMemberNodeTransport" ref="CloudSyncMemberNodeTransport"/>
   </bean>

   <!-- Pushes the un-syncing or deletiong of a node through -->
   <bean id="webscript.org.alfresco.cloud.sync.cloud-sync-delete.post"
         class="org.alfresco.enterprise.repo.web.scripts.sync.transport.CloudSyncDeletePost"
         parent="abstractCloudSyncWebScript">
        <property name="cloudSyncOnCloudService" ref="CloudSyncOnCloudService"/>
        <property name="cloudSyncMemberNodeTransport" ref="CloudSyncMemberNodeTransport"/>
   </bean>
   
   <!-- Pulls the details of changes back down for a sync -->
   <bean id="webscript.org.alfresco.cloud.sync.cloud-sync-pull.get"
         class="org.alfresco.enterprise.repo.web.scripts.sync.transport.CloudSyncPullGet"
         parent="abstractCloudSyncAbstractWebScript">
        <property name="cloudSyncMonitor" ref="cloudSyncMonitor"/>
        <property name="cloudSyncOnCloudService" ref="CloudSyncOnCloudService"/>
        <property name="cloudSyncMemberNodeTransport" ref="CloudSyncMemberNodeTransport"/>
        <property name="transactionService" ref="transactionService" />
   </bean>

   <!-- Confirms that a pull has been accepted by the remote end -->
   <bean id="webscript.org.alfresco.cloud.sync.cloud-sync-confirm.post"
         class="org.alfresco.enterprise.repo.web.scripts.sync.transport.CloudSyncConfirmPost"
         parent="abstractCloudSyncAbstractWebScript"
         init-method="init">
        <property name="syncAuditService" ref="SyncAuditService"/>
        <property name="transactionHelper" ref="retryingTransactionHelper" />
        <property name="lockService" ref="LockService"/>
   </bean>

   <!-- Marks locally that a conflict was found at the other end -->
   <bean id="webscript.org.alfresco.cloud.sync.cloud-sync-conflict.post"
         class="org.alfresco.enterprise.repo.web.scripts.sync.transport.CloudSyncConflictPost"
         parent="abstractCloudSyncWebScript">
        <property name="syncService" ref="SyncService"/>
        <property name="transactionHelper" ref="retryingTransactionHelper" />
        <property name="cloudSyncOnCloudService" ref="CloudSyncOnCloudService"/>
        <property name="cloudSyncMemberNodeTransport" ref="CloudSyncMemberNodeTransport"/>
   </bean>


   <!--                                        -->
   <!-- Web Scripts that proxy to the Cloud    -->
   <!--                                        -->

   <!-- Parent for Cloud PassThrough (Proxy) Web Scripts -->
   <bean id="abstractCloudPassThroughWebScript"
         class="org.alfresco.enterprise.repo.web.scripts.sync.connector.CloudPassThroughWebScript"
         parent="webscript" abstract="true">
        <property name="cloudConnectorService" ref="CloudConnectorService"/>
   </bean>

   <!-- Passes through GET requests -->
   <bean id="webscript.org.alfresco.cloud.passthrough.cloud-passthrough.get"
         parent="abstractCloudPassThroughWebScript">
        <property name="mapping">
           <map>
              <!-- Ensure the local parts don't overlap! -->
              <entry key="/cloud/people" value="/api/people" />
              <entry key="/cloud/sites" value="/api/sites" />
              <entry key="/cloud/tenant" value="/api/tenant" />
              <entry key="/cloud/doclib" value="/slingshot/doclib" />
              <entry key="/cloud/content" value="/webframework/content" />
              <entry key="/cloud/doclib2" value="/slingshot/doclib2" />
              <entry key="/cloud/forms" value="/api/forms" />
           </map>
        </property>
   </bean>

   <!-- Passes through POST requests -->
   <bean id="webscript.org.alfresco.cloud.passthrough.cloud-passthrough.post"
         parent="abstractCloudPassThroughWebScript">
        <property name="mapping">
           <map>
              <!-- Ensure the local parts don't overlap! -->
              <entry key="/cloud/node" value="/api/node" />
              <entry key="/cloud/forms" value="/api/forms" />
           </map>
        </property>
   </bean>

</beans>
