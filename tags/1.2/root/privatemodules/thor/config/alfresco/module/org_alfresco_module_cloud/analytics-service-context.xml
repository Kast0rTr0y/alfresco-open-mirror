<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE beans PUBLIC '-//SPRING//DTD BEAN//EN' 'http://www.springframework.org/dtd/spring-beans.dtd'>

<beans>
    
    <!-- Analytics Initialization -->
    <bean id="analytics" class="org.alfresco.module.org_alfresco_module_cloud.analytics.Analytics">
        <property name="isEnabled">
            <value>${cloud.analytics.isenabled}</value>
        </property>
        <property name="actionService" ref="ActionService"/>
        <property name="eventPublisher" ref="eventPublisher" />
    </bean>
    
    <!-- Create Send Analytics Request Action -->
    <bean id="send-analytics-request" class="org.alfresco.module.org_alfresco_module_cloud.analytics.action.SendAnalyticsRequest" parent="action-executer">
        <property name="publicAction">
            <value>false</value>
        </property>
        <property name="accountService" ref="AccountService"/>
        <property name="directoryService" ref="directoryService"/>
        <!-- Run Analytics actions on their own dedicated queue. -->
        <property name="queueName" value="analytics"/>
        <property name="analyticsDataServices">
            <list>
                <!-- MixPanel Settings -->
                <bean class="org.alfresco.module.org_alfresco_module_cloud.analytics.services.MixPanelDataService">
                    <property name="serviceName" value="MixPanel" />
                    <property name="apiKey">
                        <value>${cloud.analytics.mixpanel.apikey}</value>
                    </property>
                    <property name="isEnabled">
                        <value>${cloud.analytics.mixpanel.isenabled}</value>
                    </property>
                </bean>
                <!-- KissMetrics Settings -->
                <bean class="org.alfresco.module.org_alfresco_module_cloud.analytics.services.KissMetricsDataService">
                    <property name="serviceName" value="KissMetrics" />
                    <property name="apiKey">
                        <value>${cloud.analytics.kissmetrics.apikey}</value>
                    </property>
                    <property name="isEnabled">
                        <value>${cloud.analytics.kissmetrics.isenabled}</value>
                    </property>
                </bean>
                <!-- SimpleDB Settings -->
                <bean class="org.alfresco.module.org_alfresco_module_cloud.analytics.services.SimpleDBDataService">
                    <property name="serviceName" value="SimpleDB" />
                    <property name="apiKey">
                        <value>${cloud.analytics.simpleDB.accessKey}|${cloud.analytics.simpleDB.secretKey}</value>
                    </property>
                    <property name="simpleDBDomain">
                        <value>${cloud.analytics.simpleDB.simpleDBDomain}</value>
                    </property>
                    <property name="isEnabled">
                        <value>${cloud.analytics.simpleDB.isenabled}</value>
                    </property>
                </bean>
            </list>
        </property>
    </bean>
    
    <!-- Register the ScriptAnalyticsService object so it can be used in the JavaScript API -->
    <bean id="analyticsServiceScript" parent="baseJavaScriptExtension"
                                      class="org.alfresco.module.org_alfresco_module_cloud.analytics.scripts.ScriptAnalyticsService">
        <property name="extensionName">
            <value>analyticsService</value>
        </property>
    </bean>
    
    <!--  Put analytics actions on a dedicated asynchronous queue to ensure that they will not block
          any other ongoing asynchronous events in the system. -->
    <bean id="analyticsAsyncThreadPool" class="org.alfresco.util.ThreadPoolExecutorFactoryBean">
        <property name="poolName">
            <value>analyticsAsyncAction</value>
        </property>
        <property name="corePoolSize">
            <value>${analytics.service.corePoolSize}</value>
        </property>
        <property name="maximumPoolSize">
            <value>${analytics.service.maximumPoolSize}</value>
        </property>
    </bean>
    
    <bean id="analyticsAsynchronousActionExecutionQueue" class="org.alfresco.repo.action.AsynchronousActionExecutionQueueImpl" init-method="init">
      <property name="actionServiceImpl" ref="actionService"/>
      <property name="threadPoolExecutor">
         <ref bean="analyticsAsyncThreadPool"/>
      </property>
      <property name="transactionService">
         <ref bean="transactionService"/>
      </property>
      <property name="policyComponent">
         <ref bean="policyComponent"/>
      </property>
      <property name="id" value="analytics"/>
    </bean>
</beans>
