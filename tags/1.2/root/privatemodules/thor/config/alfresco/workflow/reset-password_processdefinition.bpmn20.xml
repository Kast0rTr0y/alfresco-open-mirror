<?xml version="1.0" encoding="UTF-8" ?>

<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:activiti="http://activiti.org/bpmn"
   xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
   typeLanguage="http://www.w3.org/2001/XMLSchema"
   targetNamespace="http://alfresco.org">

    <process id="resetPassword" name="Cloud Reset Password process">
    
        <startEvent id="start" activiti:formKey="resetpasswordwf:requestPasswordResetTask"/>
        
        <sequenceFlow sourceRef="start" targetRef="resetPasswordPathTask" />
        
        <!-- We must decide the status of the user - this determines the initial workflow path -->
        <serviceTask id="resetPasswordPathTask" name="Reset Password Path" activiti:delegateExpression="${ResetPasswordPathDelegate}">
           <extensionElements>
              <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
                 <activiti:field name="script">
                    <activiti:string>
                       execution.setVariable('resetpasswordwf_usernameStatus', task.getVariable('resetpasswordwf_usernameStatus'));
                    </activiti:string>
                 </activiti:field>
              </activiti:taskListener>
           </extensionElements>
        </serviceTask>
        
        <sequenceFlow sourceRef="resetPasswordPathTask" targetRef="resetPasswordPathOutcome" />
        
        <exclusiveGateway id="resetPasswordPathOutcome"/>
        
        <!-- Activated users -->
        <sequenceFlow sourceRef="resetPasswordPathOutcome" targetRef="sendResetPasswordEmailTask" >
            <conditionExpression>${resetpasswordwf_usernameStatus == 'Activated'}</conditionExpression>
        </sequenceFlow>
        
        <!-- Registered but not yet activated users -->
        <sequenceFlow sourceRef="resetPasswordPathOutcome" targetRef="sendActivationReminderEmailTask" >
            <conditionExpression>${resetpasswordwf_usernameStatus == 'Registered'}</conditionExpression>
        </sequenceFlow>
        
        <!-- Users completely unknown to the system -->
        <sequenceFlow sourceRef="resetPasswordPathOutcome" targetRef="sendRegistrationOrLoginEmailTask" >
            <conditionExpression>${resetpasswordwf_usernameStatus == 'None'}</conditionExpression>
        </sequenceFlow>
        
        
        <serviceTask id="sendActivationReminderEmailTask" name="Send Reminder Email from ongoing Signup Workflow"
             activiti:delegateExpression="${SendActivationReminderEmailDelegate}"
             activiti:formKey="resetpasswordwf:sendActivationReminderEmailTask"/>
        
        <sequenceFlow sourceRef="sendActivationReminderEmailTask" targetRef="end" />
        
        <serviceTask id="sendRegistrationOrLoginEmailTask" name="Start a new Signup Workflow" activiti:delegateExpression="${SendRegistrationOrLoginEmailDelegate}"
             activiti:formKey="resetpasswordwf:sendRegistrationOrLoginEmailTask"/>
        
        <sequenceFlow sourceRef="sendRegistrationOrLoginEmailTask" targetRef="end" />
        
        
        <serviceTask id="sendResetPasswordEmailTask" name="Send Reset Password Email" activiti:delegateExpression="${SendResetPasswordEmailDelegate}"
                     activiti:formKey="resetpasswordwf:sendResetPasswordEmailTask"/>
        
        <sequenceFlow sourceRef="sendResetPasswordEmailTask" targetRef="resetPasswordTask" />
        
        <!-- The password reset has been requested and is now waiting for the user to complete by clicking on the link in the email.  -->
        <!-- Note that we do not store the password as an execution variable for security reasons. -->
        <userTask id="resetPasswordTask" name="Password Reset Pending" activiti:formKey="resetpasswordwf:resetPasswordTask" />
        
        <!-- After 28 days of waiting for user to reset password, end the process -->
        <boundaryEvent id="endProcessTimer" cancelActivity="true" attachedToRef="resetPasswordTask">
   			<timerEventDefinition>
    			<timeDuration>${resetpasswordwf_endTimer}</timeDuration>
  			</timerEventDefinition>
		</boundaryEvent>      
		<sequenceFlow sourceRef="endProcessTimer" targetRef="expired" />
        
        <sequenceFlow sourceRef="resetPasswordTask" targetRef="performResetPassword" />
        
        <!-- The user has submitted the necessary data to reset the password. -->
        <serviceTask id="performResetPassword" name="Perform Reset Password" activiti:delegateExpression="${PerformResetPasswordDelegate}"
                     activiti:formKey="resetpasswordwf:resetPassword"/>
        
        <sequenceFlow sourceRef="performResetPassword" targetRef="end" />
        
        <endEvent id="end" />
        <endEvent id="expired" />
    </process>
    
</definitions>
