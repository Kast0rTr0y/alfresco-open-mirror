<?xml version="1.0" encoding="UTF-8" ?>

<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:activiti="http://activiti.org/bpmn"
   xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
   typeLanguage="http://www.w3.org/2001/XMLSchema"
   targetNamespace="http://alfresco.org">

    <process id="siteInvitationCloud" name="Cloud Site Invitation process">
        <startEvent id="start" activiti:formKey="siwf:sendSiteInvitationTask"/>
        
        <sequenceFlow sourceRef="start" targetRef="sendInvitationEmail" />
        
        <serviceTask id="sendInvitationEmail" name="Send Cloud Invitation Email"
                     activiti:delegateExpression="${SendCloudInvitationEmailDelegate}"/>
        
        <sequenceFlow sourceRef="sendInvitationEmail" targetRef="invitationAcceptancePendingTask" />
        
        <userTask id="invitationAcceptancePendingTask" name="Site Invitation Acceptance Pending"
                  activiti:formKey="siwf:invitationAcceptancePendingTask">
            <extensionElements>
               <activiti:taskListener event="complete" class="org.alfresco.repo.workflow.activiti.tasklistener.ScriptTaskListener">
                  <activiti:field name="script">
                     <activiti:string>
                        // Mandatory task properties
                        execution.setVariable('siwf_inviteeEmail', task.getVariable('siwf_inviteeEmail'));
                        execution.setVariable('siwf_key', task.getVariable('siwf_key'));
                        execution.setVariable('siwf_invitationOutcome', task.getVariable('siwf_invitationOutcome'));
                        
                        // Optional task properties
                        execution.setVariable('siwf_firstName', task.getVariable('siwf_firstName'));
                        execution.setVariable('siwf_lastName', task.getVariable('siwf_lastName'));
                        // Do not set the invitee password in the execution variable for security reasons.
                      </activiti:string>
                  </activiti:field>
               </activiti:taskListener>
            </extensionElements>
        </userTask>

      <!-- Reminder-timer boundary events don't cancel the usertask -->
      <boundaryEvent id="remindTimer3" cancelActivity="false" attachedToRef="invitationAcceptancePendingTask" name="Remind Timer 3 days">
         <timerEventDefinition>
            <!-- Repeat twice with 7-day interval -->
            <timeDuration>${siwf_remindTimer3}</timeDuration>
         </timerEventDefinition>
      </boundaryEvent>
      <boundaryEvent id="remindTimer7" cancelActivity="false" attachedToRef="invitationAcceptancePendingTask" name="Remind Timer 7, 14 and 21 days">
         <timerEventDefinition>
            <!-- Repeat 3 times with 7-day interval -->
            <timeCycle>${siwf_remindTimer7}</timeCycle>
         </timerEventDefinition>
      </boundaryEvent>
   
      <!-- End-process-timer boundary event cancels the usertask -->
      <boundaryEvent id="endProcessTimer" cancelActivity="true" attachedToRef="invitationAcceptancePendingTask" name="End Process Timer">
         <timerEventDefinition>
            <timeDuration>${siwf_endTimer}</timeDuration>
         </timerEventDefinition>
      </boundaryEvent>
   
      <sequenceFlow sourceRef="remindTimer3" targetRef="sendReminderEmailTask" />
      <sequenceFlow sourceRef="remindTimer7" targetRef="sendReminderEmailTask" />
      <sequenceFlow sourceRef="endProcessTimer" targetRef="expiredEnd" />
      
      <serviceTask id="sendReminderEmailTask" name="Send Account Activation Reminder Email" activiti:delegateExpression="${SendCloudInvitationEmailDelegate}" />
      <sequenceFlow sourceRef="sendReminderEmailTask" targetRef="timerEnd" />
        
        <sequenceFlow sourceRef="invitationAcceptancePendingTask" targetRef="invitationAcceptanceOutcome" />
        
        <exclusiveGateway id="invitationAcceptanceOutcome"/>
        
        <sequenceFlow sourceRef="invitationAcceptanceOutcome" targetRef="siteIngressTask" >
            <conditionExpression>${siwf_invitationOutcome == 'accept'}</conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow sourceRef="invitationAcceptanceOutcome" targetRef="end" >
            <conditionExpression>${siwf_invitationOutcome == 'reject'}</conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow sourceRef="invitationAcceptanceOutcome" targetRef="end" >
            <conditionExpression>${siwf_invitationOutcome == 'cancel'}</conditionExpression>
        </sequenceFlow>
        
        <sequenceFlow sourceRef="invitationAcceptanceOutcome" targetRef="manualSendReminderEmailTask" >
            <conditionExpression>${siwf_invitationOutcome == 'remind'}</conditionExpression>
        </sequenceFlow>
        
        <serviceTask id="manualSendReminderEmailTask" name="Send Manual Account Activation Reminder Email" activiti:delegateExpression="${SendCloudInvitationEmailDelegate}" />
        <sequenceFlow sourceRef="manualSendReminderEmailTask" targetRef="invitationAcceptancePendingTask" />
        
        <serviceTask id="siteIngressTask" name="Site Ingress Task" activiti:delegateExpression="${SiteIngressDelegate}"
                     activiti:formKey="siwf:siteIngressTask"/>
        
        <sequenceFlow sourceRef="siteIngressTask" targetRef="end" />
        
        <endEvent id="end" />
        
        <endEvent id="expiredEnd" />
         
        <endEvent id="timerEnd" />
    </process>
    
</definitions>
