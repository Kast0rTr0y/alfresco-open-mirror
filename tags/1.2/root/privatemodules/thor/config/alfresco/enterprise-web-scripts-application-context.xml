<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">
   <!-- Webscripts for Cloud Sync -->
   <import resource="classpath*:alfresco/sync-rest-api-context.xml" />
   
   <!-- Webscripts for Cloud Sync (Cloud Side) -->
   <!-- FIXME These should be on the Cloud Server, but not On Premise -->
   <import resource="classpath*:alfresco/sync-cloud-rest-api-context.xml" />

   <import resource="classpath:alfresco/module/org_alfresco_module_cloud/public-rest-context-override.xml"/>
   
   <!-- START of web-client-application-context.xml Explorer 5.0 move -->
   
   <!-- ===================================== -->
   <!-- Web Client Config Sources             -->
   <!-- ===================================== -->
   
   <bean id="webClientConfigSource" parent="repoUrlConfigSource">
      <constructor-arg>
         <list>
            <value>classpath:alfresco/web-client-config.xml</value>
            <value>classpath:alfresco/web-client-config-dialogs.xml</value>
            <value>classpath:alfresco/web-client-config-wizards.xml</value>
            <value>classpath:alfresco/web-client-config-properties.xml</value>
            <value>classpath:alfresco/web-client-config-navigation.xml</value>
            <value>classpath:alfresco/web-client-config-actions.xml</value>
            <value>classpath:alfresco/web-client-config-forum-actions.xml</value>
            <value>classpath:alfresco/web-client-config-workflow-actions.xml</value>
            <value>classpath:alfresco/extension/web-client-config-custom.xml</value>
            <value>jar:*!/META-INF/web-client-config-custom.xml</value>
            <value>workspace://SpacesStore/${spaces.company_home.childname}/${spaces.dictionary.childname}/app:webclient_extension/cm:web-client-config-custom.xml</value>
         </list>
      </constructor-arg>
   </bean>
   
   <bean id="repoUrlConfigSource" class="org.alfresco.repo.config.source.RepoUrlConfigSource" abstract="true">
      <property name="tenantService" ref="tenantService"/>
      <property name="searchService" ref="SearchService"/>
      <property name="contentService" ref="ContentService"/>
      <property name="namespaceService" ref="NamespaceService"/>
      <property name="nodeService" ref="NodeService"/>
   </bean>
   
   
   <!-- ===================================== -->
   <!-- Web Client Config Data Cache          -->
   <!-- ===================================== -->

   <!-- TODO: globalConfigShareCache moved into cache-context.xml files,
        may need a way of defining caches alongside related beans as it was previously. -->
   
   <bean name="globalConfigCache" class="org.alfresco.repo.config.ConfigDataCache" parent="abstractAsynchronouslyRefreshedCache">
      <property name="repoXMLConfigService" ref="webClientConfigService" />  <!-- TODO: Must we do this manually? -->
   </bean>
 
   <!-- ===================================== -->
   <!-- Web Client Config Service             -->
   <!-- ===================================== -->
   
   <bean id="webClientConfigService" class="org.alfresco.repo.config.xml.RepoXMLConfigService">
      <constructor-arg>
         <ref bean="webClientConfigSource" />
      </constructor-arg>
      <property name="transactionService" ref="transactionComponent"/>
      <property name="configDataCache"   ref="globalConfigCache"/>
   </bean>
   
   <bean id="webClientConfigAdminInterpreter" class="org.alfresco.web.config.ConfigAdminInterpreter" parent="interpreterBase">
      <property name="repoXMLConfigService" ref="webClientConfigService"/>
   </bean>
   
   <bean id="webClientConfigAdminInterpreterHelp" class="org.alfresco.i18n.ResourceBundleBootstrapComponent">
      <property name="resourceBundles">
         <list>
             <value>alfresco.messages.webclient-config-admin-interpreter-help</value>
         </list>
      </property>       
   </bean>
   
   <!-- NOTE: This references a bean in the repository Spring configuration -->
   <bean id="dataDictionary" class="org.alfresco.web.bean.repository.DataDictionary">
      <constructor-arg>
         <ref bean="DictionaryService" />
      </constructor-arg>
   </bean>
   
   <bean id="AuthenticationFilter" class="org.alfresco.repo.management.subsystems.ChainingSubsystemProxyFactory">
      <property name="applicationContextManager">
         <ref bean="Authentication" />
      </property>
      <property name="interfaces">
         <list>
            <value>org.alfresco.repo.web.filter.beans.DependencyInjectedFilter</value>
         </list>
      </property>
      <property name="sourceBeanName">
         <value>authenticationFilter</value>
      </property>
      <!-- Fall back to the default alfresco implementation -->
      <property name="defaultTarget">
         <ref bean="defaultAuthenticationFilter"/>
      </property>
   </bean>

   <bean id="defaultAuthenticationFilter" class="org.alfresco.web.app.servlet.AuthenticationFilter">
      <property name="configService">
         <ref bean="webClientConfigService" />
      </property>
   </bean>
   
   <!-- END of web-client-application-context.xml Explorer 5.0 move -->
   
   <!-- used to override core web scripts - eg. "webframework/content/metadata" -->
   <bean id="webscripts.store.thor.override" parent="webscripts.classpathstore">
      <property name="classPath"><value>alfresco/templates/webscripts_override</value></property>
   </bean>

   <bean id="webscripts.enterprise.store" parent="webscripts.classpathstore">
      <property name="mustExist"><value>true</value></property>
      <property name="classPath"><value>alfresco/enterprise/webscripts</value></property>
   </bean>
   
   <bean id="webscripts.searchpath" class="org.springframework.extensions.webscripts.SearchPath">
      <property name="searchPath">
          <list>
             <ref bean="webscripts.store.thor.override" />
             <ref bean="webscripts.store.client" />
             <ref bean="webscripts.enterprise.store" />
             <ref bean="webscripts.store.alfresco" />
             <ref bean="webscripts.store" />
          </list>
      </property>
   </bean>

   <!-- MNT-12794: Safe choice for the name of the bean in the context of enterprise tests -->
   <bean class="org.springframework.context.support.PropertySourcesPlaceholderConfigurer">
      <property name="ignoreResourceNotFound" value="true" />
      <property name="ignoreUnresolvablePlaceholders" value="true" />
      <property name="properties">
         <props>
            <prop key="parent.web.scripts.container.bean.name">#{getBeanFactory().containsBean('baseAlfrescoRepositoryContainer') ? 'baseAlfrescoRepositoryContainer' : 'webscripts.abstractcontainer'}</prop>
         </props>
      </property>
   </bean>

   <bean id="webscripts.container" class="org.alfresco.module.org_alfresco_module_cloud.webscripts.TenantSwitchingRepositoryContainer" parent="${parent.web.scripts.container.bean.name}">
      <property name="name"><value>Cloud Repository</value></property>
      <property name="scriptObjects">
         <map merge="true">
           <entry key="paging">
              <ref bean="webscripts.js.paging"/>
           </entry>
         </map>
      </property>
      <property name="templateObjects">
         <map merge="true">
		    <!-- All entries removed -->
         </map>
      </property>
      <!-- Use the time-limited transaction helper to keep request times to an acceptable duration -->
      <property name="transactionService" ref="transactionService" />
      <!-- The transaction helper used to generate error responses must be unlimited -->
      <property name="fallbackTransactionHelper" ref="retryingTransactionHelper" />
      <property name="authorityService" ref="AuthorityService" />
      <property name="repository" ref="repositoryHelper" />
      <property name="repositoryImageResolver" ref="webscripts.repo.imageresolver" />
      <property name="templateProcessorRegistry" ref="webscripts.repo.registry.templateprocessor" />
      <property name="scriptProcessorRegistry" ref="webscripts.repo.registry.scriptprocessor" />
      <property name="descriptorService" ref="DescriptorService" />
      <property name="registry" ref="webscripts.registry" />
      <property name="directoryService" ref="directoryService" />
      <property name="accountService" ref="accountService" />
      <property name="tenantAuthentication" ref="webscripts.authenticator.tenantauthentication" />
   </bean>

   <bean id="webscripts.authenticator.basic.tenant" class="org.alfresco.module.org_alfresco_module_cloud.webscripts.TenantBasicHTTPAuthenticatorFactory">
      <property name="authenticationListener" ref="webScriptAuthenticationListener"/>
      <property name="authenticationService" ref="AuthenticationService" />
      <property name="transactionHelper" ref="web.retryingTransactionHelper" />
      <property name="tenantAuthentication" ref="webscripts.authenticator.tenantauthentication"/>
      <property name="validAuthentictorKeys">
         <bean class="org.springframework.util.StringUtils" factory-method="commaDelimitedListToSet">
            <constructor-arg type="java.lang.String" value="${alfresco.authentication.validAuthenticatorKeys}"/>
         </bean>   
      </property>
      <property name="outboundHeaders">
         <bean class="org.springframework.util.StringUtils" factory-method="commaDelimitedListToSet">
            <constructor-arg type="java.lang.String" value="${alfresco.authentication.gateway.outboundHeaders}"/>
         </bean>
      </property>
   </bean>

   <bean id="webscripts.authenticator.tenantauthentication" class="org.alfresco.module.org_alfresco_module_cloud.webscripts.CloudTenantAuthentication">
      <property name="authorityService" ref="authorityService" />
      <property name="directoryService" ref="directoryService" />
      <property name="accountService" ref="accountService" />
      <property name="tenantAdminService" ref="tenantAdminService"/>
      <property name="emailAddressService" ref="emailAddressService"/>
   </bean>


    <!--                                                        -->
    <!--                Web Script Bean Overrides               -->
    <!--                                                        -->
    <bean id="webscript.org.alfresco.module.org_alfresco_module_cloud.webscripts.networkadmin"
          class="org.alfresco.module.org_alfresco_module_cloud.networkadmin.NetworkAdminWebScript"
          parent="webscript" scope="prototype">
      <property name="networkAdmin" ref="webscripts.networkadmin" />
    </bean>

    <!--  Authentication APIs - these override the login controller beans defined
          in web-scripts-application-context.xml in remote-api -->
    <bean id="webscript.org.alfresco.repository.login.get"
          class="org.alfresco.module.org_alfresco_module_cloud.webscripts.TenantLogin"
          parent="webscript">
        <property name="authenticationService" ref="AuthenticationService" />
        <property name="tenantAuthentication" ref="webscripts.authenticator.tenantauthentication"/>
        <property name="eventPublisher" ref="eventPublisher" />
    </bean>
    
    <bean id="webscript.org.alfresco.repository.login.post"
          class="org.alfresco.module.org_alfresco_module_cloud.webscripts.TenantLoginPost"
          parent="webscript">
        <property name="authenticationService" ref="AuthenticationService" />
        <property name="tenantAuthentication" ref="webscripts.authenticator.tenantauthentication"/>
        <property name="eventPublisher" ref="eventPublisher" />
    </bean>
    
   <!-- Multi-Tenancy Information, different on Cloud -->
   <bean id="webscript.org.alfresco.enterprise.repository.tenant.information.get"
         class="org.alfresco.module.org_alfresco_module_cloud.webscripts.TenantInformationGet"
         parent="webscript">
      <property name="syncAdminService" ref="syncAdminService" />
      <property name="directoryService" ref="directoryService" />
      <property name="accountService" ref="accountService" />
      <property name="tenantService" ref="tenantService" />
   </bean>

   <!-- Sync Set Definition creation, extra checks on Cloud -->
   <bean id="webscript.org.alfresco.enterprise.repository.sync.cloudonly.remotesyncsetdefinition.post"
         class="org.alfresco.module.org_alfresco_module_cloud.webscripts.RemoteSyncSetDefinitionPost"
         parent="abstractCloudSyncWebScript">
      <property name="quotaUsage" ref="tenantContentUsageImpl" />
   </bean>

   <!-- Share URLs are different on the cloud -->
   <bean id="webscript.org.alfresco.repository.site.site-share-view-url.get" 
         class="org.alfresco.module.org_alfresco_module_cloud.webscripts.SiteShareViewUrlGet" 
         parent="webscript">
      <property name="nodeService" ref="NodeService"/>
      <property name="siteService" ref="SiteService"/>
      <property name="sysAdminParams" ref="sysAdminParams" />
      <property name="dictionaryService" ref="DictionaryService"/>
   </bean>
   
   <!-- Surf config remote store access - Network Admins need special privledges -->
   <bean id="webscript.org.alfresco.repository.store.remoteadm.post" class="org.alfresco.module.org_alfresco_module_cloud.webscripts.CloudADMRemoteStore" parent="webscript">
      <property name="nodeService" ref="NodeService" />
      <property name="unprotectedNodeService" ref="nodeService" />
      <property name="mimetypeService" ref="MimetypeService" />
      <property name="fileFolderService" ref="FileFolderService"/>
      <property name="contentService" ref="ContentService"/>
      <property name="siteService" ref="SiteService" />
      <property name="hiddenAspect" ref="hiddenAspect" />
      <property name="behaviourFilter" ref="policyBehaviourFilter" />
      <property name="personService" ref="PersonService"/>
   </bean>
   <bean id="webscript.org.alfresco.repository.store.remoteadm.delete" class="org.alfresco.module.org_alfresco_module_cloud.webscripts.CloudADMRemoteStore" parent="webscript">
      <property name="nodeService" ref="NodeService" />
      <property name="unprotectedNodeService" ref="nodeService" />
      <property name="mimetypeService" ref="MimetypeService" />
      <property name="fileFolderService" ref="FileFolderService"/>
      <property name="contentService" ref="ContentService"/>
      <property name="siteService" ref="SiteService" />
      <property name="hiddenAspect" ref="hiddenAspect" />
      <property name="behaviourFilter" ref="policyBehaviourFilter" />
      <property name="personService" ref="PersonService"/>
   </bean>

   <!-- DEBUG: THOR-1288 - diagnostic logging in attempt to determine root cause -->
   <bean id="LoggerFilter" class="org.alfresco.module.org_alfresco_module_cloud.webscripts.TenantLeakLogger" />
   
   <bean id="PublicAPIAuthenticationFilter" class="org.alfresco.rest.authentication.GatewayAuthenticationFilter">
      <property name="gatewayProtocol"><value>${alfresco.authentication.gateway.protocol}</value></property>
      <property name="gatewayHost"><value>${alfresco.authentication.gateway.host}</value></property>
      <property name="gatewayPort"><value>${alfresco.authentication.gateway.port}</value></property>
      <property name="outboundHeaders">
         <bean class="org.springframework.util.StringUtils" factory-method="commaDelimitedListToSet">
            <constructor-arg type="java.lang.String" value="${alfresco.authentication.gateway.outboundHeaders}"/>
         </bean>
      </property>
      <property name="inboundHeaders">
         <bean class="org.springframework.util.StringUtils" factory-method="commaDelimitedListToSet">
            <constructor-arg type="java.lang.String" value="${alfresco.authentication.gateway.inboundHeaders}"/>
         </bean>
      </property>
      <property name="filterPrefix"><value>${alfresco.authentication.gateway.prefixUrl}</value></property>
      <property name="bufferSize"><value>${alfresco.authentication.gateway.bufferSize}</value></property>
      <property name="connectTimeout"><value>${alfresco.authentication.gateway.connectTimeout}</value></property>
      <property name="readTimeout"><value>${alfresco.authentication.gateway.readTimeout}</value></property>
      <property name="httpTcpNodelay"><value>${alfresco.authentication.gateway.httpTcpNodelay}</value></property>
      <property name="httpConnectionStalecheck"><value>${alfresco.authentication.gateway.httpConnectionStalecheck}</value></property>
   </bean>
   
   <!-- Repository Admin Console messages -->
   <bean id="repoAdminConsoleResourceBundle" class="org.alfresco.i18n.ResourceBundleBootstrapComponent">
      <property name="resourceBundles">
         <list>
            <value>alfresco.enterprise.messages.admin-console</value>
         </list>
      </property>
   </bean>
   
</beans>
