<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <artifactId>alfresco-cloud-packaging</artifactId>
    <name>Alfresco Cloud RPMs</name>
    <packaging>pom</packaging>

    <parent>
        <artifactId>alfresco-thor-parent</artifactId>
        <groupId>org.alfresco.cloud</groupId>
        <version>5.1-SNAPSHOT</version>
        <relativePath>../pom.xml</relativePath>
    </parent>

    <properties>
        <artifact.folder>${project.build.directory}/artifacts</artifact.folder>
        <buildNumber>0</buildNumber>
        <rpm.name>myalfresco${branchName}</rpm.name>
    </properties>

    <build>
        <plugins>
            <!-- Get war files -->
            <plugin>
                <artifactId>maven-dependency-plugin</artifactId>
                <executions>
                    <execution>
                        <id>fetch-wars</id>
                        <goals>
                            <goal>copy</goal>
                        </goals>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>${project.groupId}</groupId>
                                    <artifactId>alfresco-cloud</artifactId>
                                    <version>${project.version}</version>
                                    <type>war</type>
                                    <destFileName>alfresco.war</destFileName>
                                </artifactItem>
                                <artifactItem>
                                    <groupId>${project.groupId}</groupId>
                                    <artifactId>alfresco-cloud-share</artifactId>
                                    <version>${project.version}</version>
                                    <type>war</type>
                                    <destFileName>share.war</destFileName>
                                </artifactItem>
                                <artifactItem>
                                    <groupId>${alfrescoEnterprise.groupId}</groupId>
                                    <artifactId>alfresco-solr</artifactId>
                                    <version>${alfrescoEnterprise.version}</version>
                                    <classifier>nossl</classifier>
                                    <type>war</type>
                                    <destFileName>solr.war</destFileName>
                                </artifactItem>
                                <artifactItem>
                                    <groupId>${alfrescoEnterprise.groupId}</groupId>
                                    <artifactId>alfresco-solr4</artifactId>
                                    <version>${alfrescoEnterprise.version}</version>
                                    <type>war</type>
                                    <destFileName>solr4.war</destFileName>
                                </artifactItem>
                            </artifactItems>
                            <outputDirectory>${artifact.folder}</outputDirectory>
                        </configuration>
                    </execution>
                    <execution>
                        <id>fetch-solr-config</id>
                        <goals>
                            <goal>unpack</goal>
                        </goals>
                        <configuration>
                            <artifactItems>
                                <artifactItem>
                                    <groupId>${alfrescoEnterprise.groupId}</groupId>
                                    <artifactId>alfresco-solr</artifactId>
                                    <version>${project.version}</version>
                                    <classifier>config-nossl</classifier>
                                    <type>zip</type>
                                    <excludes>*-SpacesStore/conf/solrcore.properties</excludes>
                                    <outputDirectory>${project.build.directory}/Solr</outputDirectory>
                                </artifactItem>
                                <artifactItem>
                                    <groupId>${alfrescoEnterprise.groupId}</groupId>
                                    <artifactId>alfresco-solr4</artifactId>
                                    <version>${project.version}</version>
                                    <classifier>config</classifier>
                                    <type>zip</type>
                                    <excludes>*-SpacesStore/conf/solrcore.properties</excludes>
                                    <outputDirectory>${project.build.directory}/Solr4</outputDirectory>
                                </artifactItem>
                            </artifactItems>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!-- Create RPMs -->
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>rpm-maven-plugin</artifactId>
                <!-- Common configuration for all RPMs -->
                <configuration>
                    <packager>alfresco</packager>
                    <version>${version.major}.${version.minor}</version>
                    <release>${buildNumber}</release>
                    <group>root</group>
                    <defaultUsername>tomcat</defaultUsername>
                    <defaultGroupname>tomcat</defaultGroupname>
                    <preremoveScriptlet>
                        <script>#!/bin/bash - 
                            # clean out the caches
                            # war files should be owned by rpm package
                            echo -e "&#x1b;[00;32mCleaning out the caches&#x1b;[00m"
                            rm -rf /opt/tomcat7/webapps/share/
                            rm -rf /opt/tomcat7/webapps/alfresco/
                            rm -rf /opt/tomcat7/webapps/_vti_bin/
                            rm -rf /opt/tomcat7/webapps/ROOT/
                            rm -rf /var/cache/tomcat7/work/*
                            rm -rf /var/cache/tomcat7/temp/*
                            # solr cache
                            echo -e "&#x1b;[00;32mCleaning out the Solr cache&#x1b;[00m"
                            rm -rf /opt/tomcat7/Solr/*
                            rm -rf /opt/tomcat7/webapps/solr/
                            rm -rf /var/cache/tomcat7/work/Catalina/localhost/solr/
                            # solr4 cache
                            echo -e "&#x1b;[00;32mCleaning out the Solr4 cache&#x1b;[00m"
                            rm -rf /opt/tomcat7/Solr4/*
                            rm -rf /opt/tomcat7/webapps/solr4/
                            rm -rf /var/cache/tomcat7/work/Catalina/localhost/solr4/
                        </script>
                    </preremoveScriptlet>
                </configuration>

                <executions>
                    <!-- ALFRESCO ROLE -->
                    <execution>
                        <id>alfresco-rpm</id>
                        <goals>
                            <goal>rpm</goal>
                        </goals>
                        <configuration>
                            <name>${rpm.name}-alfresco-role</name>
                            <mappings>
                                <mapping>
                                    <directory>/opt/tomcat7/webapps</directory>
                                    <directoryIncluded>false</directoryIncluded>
                                    <sources>
                                        <source>
                                            <location>${artifact.folder}</location>
                                            <includes>
                                                <include>alfresco.war</include>
                                                <include>share.war</include>
                                            </includes>
                                        </source>
                                    </sources>
                                </mapping>
                            </mappings>
                            <preinstallScriptlet>
                                <script>#!/bin/bash - 
                                    # clean out the caches
                                    # war files should be owned by rpm package
                                    echo -e "&#x1b;[00;32mCleaning out the caches&#x1b;[00m"
                                    rm -rf /opt/tomcat7/webapps/share/
                                    rm -rf /opt/tomcat7/webapps/alfresco/
                                    rm -rf /opt/tomcat7/webapps/_vti_bin/
                                    rm -rf /opt/tomcat7/webapps/ROOT/
                                    rm -rf /var/cache/tomcat7/work/*
                                    rm -rf /var/cache/tomcat7/temp/*
                                </script>
                            </preinstallScriptlet>
                            <postinstallScriptlet>
                                <script>#!/bin/bash - 
                                    echo -e "&#x1b;[00;32mWars deployed. Nothing more to see here&#x1b;[00m;\n"
                                </script>
                            </postinstallScriptlet>
                        </configuration>
                    </execution>

                    <!-- SOLR ROLE -->
                    <execution>
                        <id>solr-rpm</id>
                        <goals>
                            <goal>rpm</goal>
                        </goals>
                        <configuration>
                            <name>${rpm.name}-solr-role</name>
                            <mappings>
                                <mapping>
                                    <directory>/opt/tomcat7/webapps</directory>
                                    <directoryIncluded>false</directoryIncluded>
                                    <sources>
                                        <source>
                                            <location>${artifact.folder}</location>
                                            <includes>
                                                <include>alfresco.war</include>
                                                <include>solr.war</include>
                                            </includes>
                                        </source>
                                    </sources>
                                </mapping>
                                <mapping>
                                    <directory>/opt/tomcat7/Solr</directory>
                                    <sources>
                                        <source>
                                            <location>${basedir}/src/Solr</location>
                                        </source>
                                        <source>
                                            <location>${project.build.directory}/Solr</location>
                                        </source>
                                    </sources>
                                </mapping>
                            </mappings>
                            <preinstallScriptlet>
                                <script>#!/bin/bash - 
                                    # clean out the caches
                                    # war files should be owned by rpm package
                                    echo -e "&#x1b;[00;32mCleaning out the caches&#x1b;[00m"
                                    rm -rf /opt/tomcat7/webapps/share/
                                    rm -rf /opt/tomcat7/webapps/alfresco/
                                    rm -rf /opt/tomcat7/webapps/_vti_bin/
                                    rm -rf /opt/tomcat7/webapps/ROOT/
                                    rm -rf /var/cache/tomcat7/work/*
                                    rm -rf /var/cache/tomcat7/temp/*
                                    # solr cache
                                    echo -e "&#x1b;[00;32mCleaning out the Solr cache&#x1b;[00m"
                                    rm -rf /opt/tomcat7/Solr/*
                                    rm -rf /opt/tomcat7/webapps/solr/
                                    rm -rf /var/cache/tomcat7/work/Catalina/localhost/solr/
                                </script>
                            </preinstallScriptlet>
                            <postinstallScriptlet>
                                <script>#!/bin/bash - 
                                    echo -e "&#x1b;[00;32mSolr config files&#x1b;[00m"
                                    # make sure Solr is owned by tomcat
                                    /bin/chown -R tomcat:tomcat /opt/tomcat7/Solr
                                </script>
                            </postinstallScriptlet>
                        </configuration>
                    </execution>

                    <!-- SOLR4 ROLE -->
                    <execution>
                        <id>solr4-rpm</id>
                        <goals>
                            <goal>rpm</goal>
                        </goals>
                        <configuration>
                            <name>${rpm.name}-solr4-role</name>
                            <mappings>
                                <mapping>
                                    <directory>/opt/tomcat7/webapps</directory>
                                    <directoryIncluded>false</directoryIncluded>
                                    <sources>
                                        <source>
                                            <location>${artifact.folder}</location>
                                            <includes>
                                                <include>alfresco.war</include>
                                                <include>solr4.war</include>
                                            </includes>
                                        </source>
                                    </sources>
                                </mapping>
                                <mapping>
                                    <directory>/opt/tomcat7/Solr4</directory>
                                    <sources>
                                        <source>
                                            <location>${basedir}/src/Solr</location>
                                        </source>
                                        <source>
                                            <location>${project.build.directory}/Solr4</location>
                                        </source>
                                    </sources>
                                </mapping>
                            </mappings>
                            <preinstallScriptlet>
                                <script>#!/bin/bash - 
                                    # clean out the caches
                                    # war files should be owned by rpm package
                                    echo -e "&#x1b;[00;32mCleaning out the caches&#x1b;[00m"
                                    rm -rf /opt/tomcat7/webapps/share/
                                    rm -rf /opt/tomcat7/webapps/alfresco/
                                    rm -rf /opt/tomcat7/webapps/_vti_bin/
                                    rm -rf /opt/tomcat7/webapps/ROOT/
                                    rm -rf /var/cache/tomcat7/work/*
                                    rm -rf /var/cache/tomcat7/temp/*
                                    # solr cache
                                    echo -e "&#x1b;[00;32mCleaning out the Solr4 cache&#x1b;[00m"
                                    rm -rf /opt/tomcat7/Solr4/*
                                    rm -rf /opt/tomcat7/webapps/solr4/
                                    rm -rf /var/cache/tomcat7/work/Catalina/localhost/solr4/
                                </script>
                            </preinstallScriptlet>
                            <postinstallScriptlet>
                                <script>#!/bin/bash - 
                                    echo -e "&#x1b;[00;32mSolr4 config files&#x1b;[00m"
                                    # make sure Solr is owned by tomcat
                                    /bin/chown -R tomcat:tomcat /opt/tomcat7/Solr4
                                </script>
                            </postinstallScriptlet>
                        </configuration>
                    </execution>

                    <!-- TRANS ROLE -->
                    <execution>
                        <id>trans-rpm</id>
                        <goals>
                            <goal>rpm</goal>
                        </goals>
                        <configuration>
                            <name>${rpm.name}-trans-role</name>
                            <mappings>
                                <mapping>
                                    <directory>/opt/tomcat7/webapps</directory>
                                    <directoryIncluded>false</directoryIncluded>
                                    <sources>
                                        <source>
                                            <location>${artifact.folder}</location>
                                            <includes>
                                                <include>alfresco.war</include>
                                            </includes>
                                        </source>
                                    </sources>
                                </mapping>
                            </mappings>
                            <preinstallScriptlet>
                                <script>#!/bin/bash - 
                                    # clean out the caches
                                    # war files should be owned by rpm package
                                    echo -e "&#x1b;[00;32mCleaning out the caches&#x1b;[00m"
                                    rm -rf /opt/tomcat7/webapps/share/
                                    rm -rf /opt/tomcat7/webapps/alfresco/
                                    rm -rf /opt/tomcat7/webapps/_vti_bin/
                                    rm -rf /opt/tomcat7/webapps/ROOT/
                                    rm -rf /var/cache/tomcat7/work/*
                                    rm -rf /var/cache/tomcat7/temp/*
                                </script>
                            </preinstallScriptlet>
                            <postinstallScriptlet>
                                <script>#!/bin/bash - 
                                    echo -e "&#x1b;[00;32mWars deployed. Nothing more to see here&#x1b;[00m;\n"
                                </script>
                            </postinstallScriptlet>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

</project>
