<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <artifactId>alfresco-cloud-functional-tests</artifactId>
    <name>Alfresco Cloud Functional Tests</name>
    <packaging>pom</packaging>

    <parent>
        <artifactId>alfresco-thor-parent</artifactId>
        <groupId>org.alfresco.cloud</groupId>
        <version>5.1-SNAPSHOT</version>
        <relativePath>../pom.xml</relativePath>
    </parent>

    <build>
        <plugins>
            <!-- Get solr from HEAD -->
            <plugin>
                <artifactId>maven-dependency-plugin</artifactId>
                <executions>
                    <execution>
                        <goals>
                            <goal>copy</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <artifactItems>
                        <artifactItem>
                            <groupId>${alfrescoEnterprise.groupId}</groupId>
                            <artifactId>alfresco-solr</artifactId>
                            <version>${alfrescoEnterprise.version}</version>
                            <type>zip</type>
                        </artifactItem>
                    </artifactItems>
                    <stripVersion>true</stripVersion>
                </configuration>
            </plugin>

            <!-- Tweak solr war according to THOR-219, using HTTP -->
            <plugin>
                <artifactId>maven-antrun-plugin</artifactId>
                <executions>
                    <execution>
                        <id>overlay-solr</id>
                        <phase>process-sources</phase>
                        <goals>
                            <goal>run</goal>
                        </goals>
                    </execution>
                </executions>
                <configuration>
                    <target>
                        <echo>Overlaying solr zip with Cloud configuration...</echo>
                        <unzip src="${basedir}/target/dependency/alfresco-solr.zip" dest="${basedir}/target/dependency">
                            <patternset>
                                <include name="apache-solr-1.4.1.war"/>
                            </patternset>
                        </unzip>
                        <unzip src="${basedir}/target/dependency/apache-solr-1.4.1.war" dest="${basedir}/target/dependency">
                            <patternset>
                                <include name="WEB-INF/web.xml"/>
                            </patternset>
                        </unzip>
                        <!-- Remove security stuff in the web.xml -->
                        <replaceregexp file="${basedir}/target/dependency/WEB-INF/web.xml" flags="gs"
                            match="&lt;security-constraint.*&lt;/security-role&gt;" replace="" />
                        <zip destfile="${basedir}/target/dependency/apache-solr-1.4.1.war" update="true">
                            <fileset dir="${basedir}/target/dependency" includes="WEB-INF/web.xml"/>
                        </zip>
                        <zip destfile="${basedir}/target/dependency/alfresco-solr.zip" update="true">
                            <fileset dir="${basedir}/target/dependency" includes="apache-solr-1.4.1.war"/>
                        </zip>
                    </target>
                </configuration>
            </plugin>

            <!-- Configure Tomcat with the war files -->
            <plugin>
                <groupId>org.apache.tomcat.maven</groupId>
                <artifactId>tomcat7-maven-plugin</artifactId>
                <configuration>
                    <webapps>
                        <webapp>
                            <groupId>org.alfresco.cloud</groupId>
                            <artifactId>alfresco-cloud</artifactId>
                            <version>${project.version}</version>
                            <type>war</type>
                            <contextPath>/alfresco</contextPath>
                            <asWebapp>true</asWebapp> 
                        </webapp>
                        <webapp>
                            <groupId>org.alfresco.cloud</groupId>
                            <artifactId>alfresco-cloud-share</artifactId>
                            <version>${project.version}</version>
                            <type>war</type>
                            <contextPath>/share</contextPath>
                            <asWebapp>true</asWebapp> 
                        </webapp>
                    </webapps>
                </configuration>
            </plugin>
        </plugins>
    </build>

</project>
