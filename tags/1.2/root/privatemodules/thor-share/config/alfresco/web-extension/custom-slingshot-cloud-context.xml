<?xml version='1.0' encoding='UTF-8'?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:hz="http://www.hazelcast.com/schema/spring"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                http://www.hazelcast.com/schema/spring
                http://www.hazelcast.com/schema/spring/hazelcast-spring-2.4.xsd">

	<!--
        Hazelcast distributed messaging configuration - Share web-tier cluster config (3.4.8 and 4.0.1)
        - see http://www.hazelcast.com/docs.jsp
        - and specifically http://www.hazelcast.com/docs/1.9.4/manual/single_html/#SpringIntegration
   -->
   <!-- Configure cluster to use either Multicast or direct TCP-IP messaging - multicast is default -->
   <!-- Optionally specify network interfaces - server machines likely to have more than one interface -->
   <!-- The messaging topic - the "name" is also used by the persister config below -->
   <hz:topic id="topic" instance-ref="webframework.cluster.slingshot" name="slingshot-topic"/>
   <hz:hazelcast id="webframework.cluster.slingshot">
      <hz:config>
         <hz:group name="sharetest" password="testshare"/>
         <hz:properties>
            <hz:property name="hazelcast.mancenter.enabled">false</hz:property>
            <hz:property name="hazelcast.rest.enabled">false</hz:property>
            <hz:property name="hazelcast.memcache.enabled">false</hz:property>
         </hz:properties>
         <hz:network port="5801" port-auto-increment="true">
            <hz:join>
               <hz:multicast enabled="false"
                     multicast-group="224.2.2.5"
                     multicast-port="54327"/>
               <hz:tcp-ip enabled="true">
                  <hz:members></hz:members>
               </hz:tcp-ip>
            </hz:join>
            <hz:interfaces enabled="false">
               <hz:interface>192.168.1.*</hz:interface>
            </hz:interfaces>
         </hz:network>
      </hz:config>
   </hz:hazelcast>

   <!-- Override Slingshot's & Web Framework Abstract Handler Mappings -->
   <bean id="webframeworkHandlerMappings" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping" abstract="true">
      <property name="urlPathHelper" ref="urlPathHelper" />
      <property name="pathMatcher" ref="pathMatcher" />
      <property name="interceptors">
         <list>
            <ref bean="requestContextInterceptor"/>
            <ref bean="userDashboardInterceptor"/>
            <ref bean="editionInterceptor"/>
         </list>
      </property>
      <property name="mappings">
         <value>
            /saml-authnresponse**=samlIDPAuthnResponseController
            /saml-logoutresponse**=samlIDPLogoutResponseController
            /system/**=remoteController
            /proxy/**=endpointController
            /resource/**=resourceController
            /feed/**=feedController
            /dologin/**=loginController
            /dologout/**=logoutController
         </value>
      </property>
   </bean>
   
   <!--            -->
   <!-- Cloud SAML -->
   <!--            -->
   
   <!-- SAML Login (SSO) Request / Response -->
   
   <bean id="samlIDPAuthnResponseController" class="org.alfresco.module.org_alfresco_module_cloud_share.web.site.servlet.TenantSAMLIDPAuthnResponseController">
      <property name="cacheSeconds" value="-1" />
      <property name="useExpiresHeader"><value>true</value></property>
      <property name="useCacheControlHeader"><value>true</value></property>
      <property name="serviceRegistry" ref="webframework.service.registry" />
      <property name="userFactory" ref="webframework.factory.user.tenant" />
   </bean>
   
   <bean id="loginController" class="org.alfresco.module.org_alfresco_module_cloud_share.web.site.servlet.TenantSAMLLoginController">
      <property name="cacheSeconds" value="-1" />
      <property name="useExpiresHeader"><value>true</value></property>
      <property name="useCacheControlHeader"><value>true</value></property>
      <property name="connectorService" ref="connector.service" />
      <property name="userFactory" ref="webframework.factory.user.tenant" />
      <property name="supportedMethods">
         <list>
            <value>HEAD</value>
            <value>POST</value>
            <value>OPTIONS</value>
         </list>
      </property>
   </bean>
   
   <!-- SAML Logout (SP initiated SLO) Request / Response -->
   
   <bean id="samlIDPLogoutResponseController" class="org.alfresco.module.org_alfresco_module_cloud_share.web.site.servlet.TenantSAMLIDPLogoutResponseController">
      <property name="cacheSeconds" value="-1" />
      <property name="useExpiresHeader"><value>true</value></property>
      <property name="useCacheControlHeader"><value>true</value></property>
      <property name="connectorService" ref="connector.service" />
   </bean>
   
   <bean id="logoutController" class="org.alfresco.module.org_alfresco_module_cloud_share.web.site.servlet.TenantSAMLLogoutController">
      <property name="cacheSeconds" value="-1" />
      <property name="useExpiresHeader"><value>true</value></property>
      <property name="useCacheControlHeader"><value>true</value></property>
      <property name="connectorService" ref="connector.service" />
      <property name="supportedMethods">
         <list>
            <value>HEAD</value>
            <value>POST</value>
            <value>OPTIONS</value>
         </list>
      </property>
   </bean>

   <!-- SAML Logout (IDP initiated SLO) Request / Response -->

   <bean id="webscript.org.alfresco.cloud.core.components.saml.logoutrequest.post" class="org.alfresco.module.org_alfresco_module_cloud_share.web.scripts.saml.LogoutRequestPOST">
      <property name="connectorService" ref="connector.service" />
   </bean>


   <bean id="webframework.slingshot.persister.remote" class="org.alfresco.module.org_alfresco_module_cloud_share.TenantClusterAwarePathStoreObjectPersister" parent="webframework.sitedata.persister.abstract">
      <property name="store" ref="webframework.webapp.store.remote" />
      <property name="pathPrefix"><value>alfresco/site-data/${objectTypeIds}</value></property>
      <property name="hazelcastInstance" ref="webframework.cluster.slingshot" />
      <property name="hazelcastTopicName"><value>slingshot-topic</value></property>
   </bean>
   
   <bean id="webframework.factory.requestcontext.servlet" class="org.alfresco.web.site.ClusterAwareRequestContextFactory" parent="webframework.factory.base">
      <property name="linkBuilderFactory" ref="webframework.factory.linkbuilder.servlet" />
      <property name="extensibilityModuleHandler" ref="webscripts.extensibility.handler" />
      <property name="dependencyHandler" ref="dependency.handler" />
      <property name="webFrameworkConfigElement" ref="webframework.config.element"/>
      <property name="clusterObjectPersister" ref="webframework.slingshot.persister.remote" />
   </bean>

   <!-- Replaces the default directive factory to instantiate Cloud specific directives that ensure that
        the default tenant is used in the dependency requests -->
   <bean id="directive.factory" parent="directive.factory.abstract" class="org.alfresco.module.org_alfresco_module_cloud_share.CloudDirectiveFactory"/>

   <!-- Override dependy handler to take the tenant name in account for resource requests -->
   <bean id="dependency.handler" parent="dependency.handler.abstract" class="org.springframework.extensions.surf.DependencyHandler">
      <property name="resourceControllerMapping" value="/-default-/res" />
   </bean>

   <!-- Overrides the default abstract remote store to use the TenantRemoteStore which prefixes
        request URLs with the requested tenant information. This is required in order for it
        to work with the overridden "alfresco" endpoint. -->
   <bean id="webscripts.remotestore" class="org.alfresco.module.org_alfresco_module_cloud_share.TenantRemoteStore" abstract="true" />
   <bean id="url.helper.factory" class="org.alfresco.module.org_alfresco_module_cloud_share.TenantURLHelperFactory"/>
   <bean id="url.model.factory" class="org.alfresco.module.org_alfresco_module_cloud_share.TenantURLModelFactory"/>
   
   <!-- Override RemoteClient bean for building Tenant specific URLs -->
   <bean id="connector.remoteclient" parent="connector.remoteclient.abstract"
         class="org.alfresco.module.org_alfresco_module_cloud_share.LocaleTenantRemoteClient" scope="prototype">
      <!-- the http.connection.timeout value in milliseconds to apply to HTTP connections -->
      <property name="connectTimeout"><value>30000</value></property>
      <!-- the http.socket.timeout value in milliseconds to apply to HTTP connections -->
      <property name="readTimeout"><value>600000</value></property>
      <!-- remove Origin header in share proxy calls for CORS -->
      <property name="removeRequestHeaders"> 
        <set>  
          <value>Origin</value>
          <value>Host</value>
        </set> 
     </property>
     <property name="localeResolver" ref="localeResolver" /> 
   </bean>
   
   <bean id="endpointController" class="org.alfresco.module.org_alfresco_module_cloud_share.LocaleEndPointProxyController">
      <property name="cacheSeconds" value="-1" />
      <property name="useExpiresHeader"><value>true</value></property>
      <property name="useCacheControlHeader"><value>true</value></property>
      <property name="configService" ref="web.config" />
      <property name="connectorService" ref="connector.service" />
      <property name="supportedMethods"><null/></property>
      <property name="proxyControllerInterceptor" ref="slingshotProxyControllerInterceptor" />
      <property name="localeResolver" ref="localeResolver" /> 
   </bean>
   
   <!-- Override store persisters for Thor Tenant support -->
   <bean id="webframework.sitedata.persister.alfresco-classpath" class="org.alfresco.module.org_alfresco_module_cloud_share.TenantStoreObjectPersister" parent="webframework.sitedata.persister.abstract">
      <property name="store" ref="webframework.sitedata.store.alfresco-classpath" />
   </bean>
   <bean id="webframework.sitedata.persister.classpath.alfresco-custom" class="org.alfresco.module.org_alfresco_module_cloud_share.TenantStoreObjectPersister" parent="webframework.sitedata.persister.abstract">
      <property name="store" ref="webframework.sitedata.store.classpath.alfresco-custom" />
   </bean>
   <bean id="webframework.sitedata.persister.classpath" class="org.alfresco.module.org_alfresco_module_cloud_share.TenantStoreObjectPersister" parent="webframework.sitedata.persister.abstract">
      <property name="store" ref="webframework.sitedata.store.classpath" />
   </bean>
   
   <!-- 
      The SlingshotUserFactory has been replaced by the TenantUserFactory (and the reference in surf.xml has been updated)
      <bean id="webframework.factory.user.slingshot" class="org.alfresco.web.site.SlingshotUserFactory" parent="webframework.factory.base" />
   -->
   <bean id="webframework.factory.user.tenant" class="org.alfresco.module.org_alfresco_module_cloud_share.TenantUserFactory" parent="webframework.factory.base" />
   
      <!-- Override Page View and Page Type View Resolvers to provide access to http req for MT auth support during view name resolution -->
   <bean id="pageViewResolver" class="org.alfresco.module.org_alfresco_module_cloud_share.TenantPageViewResolver" parent="abstractWebFrameworkViewResolver">
      <property name="userFactory" ref="webframework.factory.user.tenant"/>
   </bean>
   <bean id="pageTypeViewResolver" class="org.alfresco.module.org_alfresco_module_cloud_share.TenantPageTypeViewResolver" parent="abstractWebFrameworkViewResolver">
      <property name="userFactory" ref="webframework.factory.user.tenant"/>
   </bean>
   
   <!-- Override WebScript Messages - add slingshot application messages -->
   <bean id="cloud.custom.resources" class="org.springframework.extensions.surf.util.ResourceBundleBootstrapComponent">
      <property name="resourceBundles">
         <list>
            <value>alfresco.messages.cloud</value>
         </list>
      </property>
   </bean>

   <!-- Locale Resolver -->
   <bean id="localeResolver" class="org.alfresco.module.org_alfresco_module_cloud_share.CloudLocaleResolver">
      <!--
         List of languages that will be allowed, the first in the list will be used as default if an
         unallowed language is set in the browser
      -->
      <property name="languages">
         <list>
            <!-- English -->
            <value>en</value>
            <!-- German -->
            <value>de</value>
            <!-- Spanish -->
            <value>es</value>
            <!-- French -->
            <value>fr</value>
            <!-- Italian -->
            <value>it</value>
            <!-- Japanese -->
            <value>ja</value>
         </list>
      </property>
   </bean>

   <bean id="cloud.custom.config" class="org.springframework.extensions.config.ConfigBootstrap" init-method="register">
      <property name="configService" ref="web.config" />
      <property name="configs">
         <list>
            <value>classpath:alfresco/web-extension/cloud-config.xml</value>
            <value>classpath:alfresco/web-extension/cloud-config-env.xml</value>
         </list>
      </property>
   </bean>

   <!-- Module extensibility evaluators -->
   <bean id="cloud-account.module.evaluator" class="org.alfresco.module.org_alfresco_module_cloud_share.extensibility.SlingshotCloudAccountModuleEvaluator">
      <property name="slingshotEvaluatorUtil" ref="slingshot.evaluator.utility" />
   </bean>
   
   <!-- THOR-249: override interceptor (see 'slingshot-application-context.xml') -->
   <bean id="editionInterceptor" class="org.alfresco.module.org_alfresco_module_cloud_share.CloudEditionInterceptor" parent="abstractWebFrameworkInterceptor" />

	<!-- CLOUD-1368: override script bean (see 'slingshot-application-context.xml') -->
   <bean id="slingshot.scriptprocessor.dictionaryQuery" parent="baseScriptExtension" class="org.alfresco.module.org_alfresco_module_cloud_share.CloudDictionaryQuery">
      <property name="extensionName" value="dictionary" />
   </bean>

   <bean id="webscript.org.alfresco.cloud.core.components.feedback.new-relic-header.get" class="org.alfresco.cloud.components.feedback.NewRelicHeader" parent="webscript"/>
   <bean id="webscript.org.alfresco.cloud.core.components.feedback.new-relic-footer.get" class="org.alfresco.cloud.components.feedback.NewRelicFooter" parent="webscript"/>

   <!-- Overriding the bean for unsync action evaluator to make it available for a network admin to force an unsync of a document/folder -->
   <bean id="evaluator.doclib.action.isNetworkAdmin" class="org.alfresco.web.evaluator.IsNetworkAdminEvaluator"/>
   <bean id="evaluator.doclib.action.isUnsyncable" parent="evaluator.doclib.action.chainedMatchAll">
      <property name="evaluators">
         <list>
            <ref bean="evaluator.doclib.action.isSyncedAspect" />
            <ref bean="evaluator.doclib.action.isSyncModeCloud" />
            <ref bean="evaluator.doclib.action.isSyncedDirectly" />
            <ref bean="evaluator.doclib.action.isNetworkAdmin" />
            <ref bean="evaluator.doclib.action.isNotPartOfHybridWorklfow" />
         </list>
      </property>
   </bean>

   <bean id="evaluator.doclib.action.isSyncModeCloud" parent="evaluator.doclib.action.syncMode">
      <property name="syncMode" ref="slingshot.scriptprocessor.syncModeConfig" />
      <property name="validMode" value="CLOUD" />
   </bean>

   <bean id="evaluator.doclib.action.isSyncOn" parent="evaluator.doclib.action.chainedMatchOne">
      <property name="evaluators">
         <list>
            <ref bean="evaluator.doclib.action.isSyncModeCloud"/>
         </list>
      </property>
   </bean>

   <!-- Override FormUIGet webscript controller to include tenant in submission url -->
   <bean id="webscript.org.alfresco.components.form.form.get" class="org.alfresco.module.org_alfresco_module_cloud_share.scripts.forms.TenantFormUIGet" parent="webscript">
      <property name="configService" ref="web.config" />
   </bean>

</beans>